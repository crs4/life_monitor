version: "3.5"

services:
  nginx:
    image: bitnami/nginx:1.19-debian-10
    depends_on:
      - "lm"
    ports:
      - "8443:8443"
    restart: "always"
    healthcheck:
      test: >
        /bin/sh -c "http_code=$$(curl --insecure https://lm:8443/health -s -w %{http_code}); if [ $${http_code} -eq 502 ]; then exit 1; fi;"
      interval: "2s"
      retries: 3
      timeout: "1s"
    networks:
      - life_monitor
    volumes:
      - "./certs:/nginx/certs:ro"
      - "./docker/nginx.conf:/opt/bitnami/nginx/conf/server_blocks/lm.conf:ro"
      - "data_static_files:/app/lifemonitor/static:ro"
      - "data_specs:/app/specs:ro"

  lm:
    environment:
      - "PROMETHEUS_MULTIPROC_DIR=$${PROMETHEUS_MULTIPROC_DIR}"
    volumes:
      - "$${PROMETHEUS_MULTIPROC_DIR}:$${PROMETHEUS_MULTIPROC_DIR}"
  worker:
    environment:
      - "PROMETHEUS_MULTIPROC_DIR=$${PROMETHEUS_MULTIPROC_DIR}"
    volumes:
      - "$${PROMETHEUS_MULTIPROC_DIR}:$${PROMETHEUS_MULTIPROC_DIR}"
    
  metrics:
    image: crs4/lifemonitor
    entrypoint: lm-metrics-server 8001
    restart: "always"
    depends_on:
      - "db"
      - "init"
    env_file:
      - settings.conf
    environment:
      - "PROMETHEUS_MULTIPROC_DIR=$${PROMETHEUS_MULTIPROC_DIR}"
      - "FLASK_ENV=production"
      - "POSTGRESQL_HOST=db"
      - "POSTGRESQL_PORT=5432"
    volumes:
      - "./certs:/certs:ro"
      - "./instance:/lm/instance:ro"
      - "./settings.conf:/lm/settings.conf:ro" # default settings
      - "data_workflows:/var/data/lm"
      - "$${PROMETHEUS_MULTIPROC_DIR}:$${PROMETHEUS_MULTIPROC_DIR}"
    ports:
      - "8001:8001"
    networks:
      - life_monitor
